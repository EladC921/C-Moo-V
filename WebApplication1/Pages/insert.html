<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>C-Moo-V</title>


    <script src="../Scripts/ajaxCalls.js"></script>

    <style type="text/css">
        #ph > img {
            height: 300px;
        }


        #seasonDiv img {
            height: 200px;
        }

        #statusTbl {
            position: absolute;
            right: 100px;
            bottom: 50px;
        }

        /*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Carousel - Style ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
        /* The heart of the matter */
        .testimonial-group > .row {
            overflow-x: auto;
            white-space: nowrap;
        }

            .testimonial-group > .row > .col-xs-4 {
                display: inline-block;
                float: none;
            }

        .card:hover {
            cursor: pointer;
        }

        /* Decorations */
        .col-xs-4 {
            color: #fff;
            font-size: 48px;
            padding-bottom: 20px;
            padding-top: 18px;
        }

            .col-xs-4:nth-child(3n+1) {
                background: #c69;
            }

            .col-xs-4:nth-child(3n+2) {
                background: #9c6;
            }

            .col-xs-4:nth-child(3n+3) {
                background: #69c;
            }

        /*scroll-bar-css*/
        /* width */
        ::-webkit-scrollbar {
            width: 10px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: rgba(102, 93, 102,0.3);
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #9d3be1;
        }

            /* Handle on hover */
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
        /*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ End of Carousel style ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
    </style>
    <!-- ICON -->
    <link rel="icon" href="https://media.discordapp.net/attachments/727187267788996640/854969393481646090/sacred-cow.png">

    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>

    <!-- Carousel scripts -->
    <script src='https://production-assets.codepen.io/assets/common/stopExecutionOnTimeout-b2a7b3fe212eaa732349046d8416e00a9dec26eb7fd347590fbced3ab38af52e.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/Swiper/3.3.1/js/swiper.min.js'></script>

    <!-- Links -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.dataTables.min.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>


    <!-- Links - slider -->
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <!------ Carousel ---------->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <script>

        // https://api.themoviedb.org/3/search/tv?api_key=1c107f2bd2f3fc2aee24aa4f2f8d8647&language=en-US&page=1&include_adult=false&query=Grey%27s%20Anatomy

        seasons = [];
        $(document).ready(function () {
            if (localStorage.user != null) { //if user already logged in, details saved -> auto-login
                user = JSON.parse(localStorage.user);
                console.log(user);
                alert("Hello " + user.Name + " " + user.Sername);
                window.addEventListener("beforeunload", function (event) { });
                window.onbeforeunload = function (event) { };
            }

            //logout -> clear localStorage and return to homepage
            $("#logout").click(function () {
                api = "../api/Users/" + user.Id + "?status=Logout";
                ajaxCall("PUT", api, "", changeStatusSuccessCB, error);
            })

            loadUsersOnline();


            $("#getTV").click(getTV);

            //key from tmdb
            key = "fe72ae4f33f6eb8a2b98a62fb320f4ec";
            api_key = "api_key=" + key;

            url = "https://api.themoviedb.org/";
            imagePath = "https://image.tmdb.org/t/p/w500/";

            //https://api.themoviedb.org/3/tv/1416/season/0/episode/64467?api_key=1c107f2bd2f3fc2aee24aa4f2f8d8647&language=en-US

            $("#view").click(function () {
                window.location.href = "view.html";
            })
        });


        //change status to Offline after Logout success
        function changeStatusSuccessCB() {
            localStorage.clear();
            window.location.href = "homePage.html";
        }

        //Global error method
        function error(err) {
            console.log(err);
        }

        function getTV() {

            let name = $("#tvShowName").val();
            let method = "3/search/tv?";
            let moreParams = "&language=en-US&page=1&include_adult=false&";
            let query = "query=" + encodeURIComponent(name);

            let apiCall = url + method + api_key + moreParams + query;
            ajaxCall("GET", apiCall, "", getTVSuccessCB, error);
        }

        // TV Success

        function getTVSuccessCB(tv) {

            console.log("Results:")
            console.log(tv.results)
            let str = "";
            //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ TV ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
            for (var i = 0; i < tv.results.length; i++) {
                str += "<div id=" + tv.results[i].id + " class='card card-block mx-2' style='width: 18rem; background-color: rgba(255, 255, 255, 0.8);'>";
                str += "<img src='" + imagePath + tv.results[i].poster_path + "' onclick='randSeasons(" + tv.results[i].id + ")' class='card-img-top' alt='...'/> "; //make a clickable img of the TV Show
                str += '<div class="card-body">';
                str += "<h3>" + tv.results[i].name + "</h3>" //TV Name
                str += "</div></div>";
                $("#seasonDiv").append(str);
            }
            console.log(str);
            $("#ph").html(str);
            //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ TV ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

        }

        //Rand the seasons of the TV Show
        function randSeasons(id) {
            tv_id = id; //make it global
            console.log("checkpoint");
            let apiTv = "https://api.themoviedb.org/3/tv/" + tv_id + "?api_key=fe72ae4f33f6eb8a2b98a62fb320f4ec&language=en-US";
            ajaxCall("GET", apiTv, "", getSpecificTvSuccessCB, error);

        }

        //get specific tv show SUCCESS
        function getSpecificTvSuccessCB(tv) {
            tv_show = tv; //make it global
            console.log("checkpoint: tv show")
            console.log(tv_show);
            number_of_seasons = tv_show.number_of_seasons;

            //rand to page
            $("#ph").html("");
            let str = "";
            for (var i = 0; i < number_of_seasons; i++) {
                id = tv_show.seasons[i].id;
                str += "<div id = " + id + ">";
                str += "<h3>" + tv_show.seasons[i].season_number + ". " + tv_show.seasons[i].name + "</h3>"
                str += "<img src='" + imagePath + tv_show.seasons[i].poster_path + "' onclick='randEps(" + tv_show.seasons[i].season_number + ")' /> "; //make a clickable img of the Seaoson
                str += "</div>";
            }
            $("#ph").html(str);
        }

        //Rand the Episodes of the season
        function randEps(i) {
            apiSeason = "https://api.themoviedb.org/3/tv/" + tv_id + "/season/" + i + "?api_key=fe72ae4f33f6eb8a2b98a62fb320f4ec&language=en-US";
            ajaxCall("GET", apiSeason, "", getEpsSuccessCB, error);
        }

        //Get the season success - generate episodes
        function getEpsSuccessCB(_season) {
            console.log("checkpoint: season");
            console.log(_season);
            season = _season
            number_of_eps = season.episodes.length;


            //rand to page
            $("#ph").html("");
            let str = "";
            for (var i = 0; i < number_of_eps; i++) {
                id = season.episodes[i].id;
                str += "<div id = " + id + ">";
                str += "<h3>" + season.episodes[i].episode_number + ". " + season.episodes[i].name + "</h3>"; //episode name
                str += "<img src='" + imagePath + season.episodes[i].still_path + "'/> ";  //image
                str += "<p>" + season.episodes[i].overview + "\nAir Date: " + season.episodes[i].air_date + "</p>";
                str += "<button value=" + i + " onclick='insert(this.value)'>Insert</button>"; //insert episode button
                str += "</div>";
            }
            $("#ph").html(str);

            //Put the actors
            apiCredits = "https://api.themoviedb.org/3/tv/" + tv_show.id + "/season/" + season.season_number + "/credits?api_key=fe72ae4f33f6eb8a2b98a62fb320f4ec&language=en-US";
            ajaxCall("GET", apiCredits, "", getCreditsSuccessCB, error);
        }



        //Insert button handler
        function insert(i) {
            //Creation of season object
            ser = {
                Id: tv_show.id,
                First_air_date: tv_show.air_date,
                Name: tv_show.name,
                Origin_country: tv_show.origin_country[0],
                Original_language: tv_show.original_language,
                Overview: tv_show.overview,
                Popularity: tv_show.overview,
                Poster_path: tv_show.poster_path
            }

            //Creation of episode object
            ep = {
                Id: season.episodes[i].id,
                Id_user: user.Id, //For preference table
                EpName: season.episodes[i].name,
                Id_ser: tv_show.id,
                SerName: tv_show.name,
                SeasonNum: season.season_number,
                Img: imagePath + season.episodes[i].still_path,
                Description: season.episodes[i].overview + "\nAir Date: " + season.episodes[i].air_date
            }

            console.log("checkpoint: Episode Object to Insert");
            console.log(ep);

            //POST series object
            let apiSeries = "../api/Series";
            ajaxCall("POST", apiSeries, JSON.stringify(ser), postSeriesSuccessCB, error);
        }

        //Post series Success
        function postSeriesSuccessCB() {
            console.log("Breakpoint: SERIES POST SUCCESS")
            //using POST through ajax call to add the object to the episode list
            let apiEps = "../api/Episodes";
            ajaxCall("POST", apiEps, JSON.stringify(ep), postEpsSuccessCB, error);
        }


        //Post Episode Success
        function postEpsSuccessCB(msg) {
            if (msg == -1)
                console.log("episode already exists in sql table therefore wasn't added once again")
            alert("Episode inserted");
        }

        //GET Credits and cast Success
        function getCreditsSuccessCB(credits) {
            console.log("checkpoint: credits")
            console.log(credits);
            let str = "";
            for (var i = 0; i < credits.cast.length; i++) {
                str += "<div id = " + credits.cast[i].id + ">";
                str += "<h3>" + credits.cast[i].name + "</h3>"; //actor name
                str += "<img src='" + imagePath + credits.cast[i].profile_path + "'/> ";  //image
                str += "<h4>" + credits.cast[i].character + "</h4>"; //character name
                str += "</div>";
            }
            $("#ph").append(str);

        }

        //Load all the users that are online
        function loadUsersOnline() {
            let api = "../api/Users";
            ajaxCall("GET", api, "", getUsersSuccess, error);
        }

        //GET users list success
        function getUsersSuccess(uList) {
            console.log(uList);
            usersOnline = [];
            j = 0;
            for (var i = 0; i < uList.length; i++) {
                if (uList[i].Status == 'Online') {
                    usersOnline[j] = uList[i];
                    j++;
                }
            }
            loadUsersOnlineTbl(usersOnline);
        }

        //Put the online users in the table
        function loadUsersOnlineTbl(usersOnline) {
            console.log(usersOnline);
            try {
                statusTbl = $('#statusTable').DataTable({
                    data: usersOnline,
                    pageLength: 5,
                    columns: [
                        { data: "Name" },
                        { data: "Status" },
                    ],
                });
            }
            catch (err) {
                alert(err);
            }
        }
    </script>

    <!-- Carousel Scripts js-->
    <!-- End of Carousel Scripts -->
</head>
<!-- BODY -->
<body>
    <button id="logout">Logout</button><br />
    <hr />
    <h2>Search a TV show</h2>
    <input type="text" id="tvShowName" />
    <button id="getTV">Get TV Show</button>
    <button id="view">View My Episodes</button>
    <!--<div id="ph">
    </div>-->
    <!--Carousel Slider -->

    <section class="page-section  mb-0" id="main">
        <div class="container">
            <div class="container testimonial-group">
                <div class="row card_row rounded d-flex flex-row flex-nowrap overflow-auto shadow" id="ph">
                    <!--<div class="card card-block mx-2" style="width: 18rem; background-color: rgba(255, 255, 255, 0.8);">
                        <img src='https://media.discordapp.net/attachments/727187267788996640/854969393481646090/sacred-cow.png' class='card - img - top' alt='...' />
                        <div class="card-body">
                            <h3>Cow 1</h3>
                        </div>
                    </div>
                    <div class="card card-block mx-2" style="width: 18rem; background-color: rgba(255, 255, 255, 0.8);">
                        <img src='https://cdn.discordapp.com/attachments/727187267788996640/854961316899717161/cow.png' class='card-img-top' alt='...' />
                        <div class="card-body">
                            <h3>Cow 2</h3>
                        </div>
                    </div>
                    <div class="card card-block mx-2" style="width: 18rem; background-color: rgba(255, 255, 255, 0.8);">
                        <img src='https://media.discordapp.net/attachments/727187267788996640/854969393481646090/sacred-cow.png' class='card - img - top' alt='...' />
                        <div class="card-body">
                            <h3>Cow 1</h3>
                        </div>
                    </div>
                    <div class="card card-block mx-2" style="width: 18rem; background-color: rgba(255, 255, 255, 0.8);">
                        <img src='https://cdn.discordapp.com/attachments/727187267788996640/854961316899717161/cow.png' class='card-img-top' alt='...' />
                        <div class="card-body">
                            <h3>Cow 2</h3>
                        </div>
                    </div>
                    <div class="card card-block mx-2" style="width: 18rem; background-color: rgba(255, 255, 255, 0.8);">
                        <img src='https://media.discordapp.net/attachments/727187267788996640/854969393481646090/sacred-cow.png' class='card - img - top' alt='...' />
                        <div class="card-body">
                            <h3>Cow 1</h3>
                            <p> MUCH INFORMATION </p>
                        </div>
                    </div>-->
                </div>
            </div>
        </div>
    </section>
    <!-- End of Carousel Slider -->
    <!-- Users Online Table-->
    <!--<div id="statusTbl">
        <h2 id="statusData">Users online:</h2>
        <table id="statusTable" class="display nowrap" style="width:100%">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Status</th>
                </tr>
            </thead>
        </table>
    </div>-->
</body>
</html>

<!--
                    <div id="ph" class="row text-center">

                    </div>-->
